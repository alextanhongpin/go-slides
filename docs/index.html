
<!DOCTYPE html>
<html>
  <head>
    <title>HTTP Snapshot Testing</title>
    <meta charset='utf-8'>
    <script>
      var notesEnabled =  false ;
    </script>
    <script src='./static/slides.js'></script>

    
  </head>

  <body style='display: none'>

    <section class='slides layout-widescreen'>

      <article>
        <h1>HTTP Snapshot Testing</h1>
        <h3>Testing made simple with snapshot</h3>
        <h3>4 June 2023</h3>
        
          <div class="presenter">
            
  
  <p>
    Alex Tan Hong Pin
  </p>
  

  
  <p>
    Sofware Engineer
  </p>
  

          </div>
        
          <div class="presenter">
            
  
  <p>
    
  </p>
  

          </div>
        
      </article>

  
  
      <article >
      
        <h3>Agenda</h3>
        <ul>
<li>Goal and Motivation</li>
<li>Key concepts of Snapshot Testing
<ul>
<li>What is Snapshot Testing?</li>
<li>How does Snapshot Testing works?</li>
</ul>
</li>
<li>Dump Format
<ul>
<li>Dot HTTP</li>
<li>JSON</li>
</ul>
</li>
<li>Basic Example</li>
<li>Advanced Example</li>
</ul>

      
      <span class="pagenumber">2</span>
      </article>
  
  
  
      <article >
      
        <h3>Goal and Motivation</h3>
        <p>To write simple and maintainable tests that also serves as documentation</p>

      
      <span class="pagenumber">3</span>
      </article>
  
  
  
      <article >
      
        <h2>Key Concepts of Snapshot Testing</h2>
      
      <span class="pagenumber">4</span>
      </article>
  
  
  
      <article >
      
        <h3>What is Snapshot Testing?</h3>
        <p>Snapshot testing is a type of testing that compares the current output of a component or application to a known good output.</p>
<ul>
<li>Snapshot tests are typically used for UI testing, but can also be used for other types of testing.</li>
<li>Snapshot tests are easy to write and maintain, and can help to prevent regressions in your code.</li>
<li>Snapshot tests are not a replacement for unit or functional tests, but can be used in conjunction with them to provide a comprehensive testing suite.</li>
</ul>

      
      <span class="pagenumber">5</span>
      </article>
  
  
  
      <article >
      
        <h3>How does Snapshot Testing works?</h3>
        <ul>
<li>Snapshot tests are typically written using a special syntax that allows you to capture the output of a component or application.</li>
<li>The captured output is then stored in a file, which is compared to the output of the component or application during each test run.</li>
<li>If the output of the component or application changes, the snapshot test will fail.</li>
<li>This helps to ensure that the output of your component or application does not change unexpectedly, which can help to prevent regressions.</li>
</ul>

      
      <span class="pagenumber">6</span>
      </article>
  
  
  
      <article >
      
        <h3>Dump Format</h3>
        <p>To come up with a dump format, we need to fulfil the following criteria</p>
<ul>
<li>human-readable</li>
<li>can be easily compared</li>
</ul>
<p>Proposed format:</p>
<ul>
<li><code>.http</code> (dot HTTP)</li>
<li><code>.json</code></li>
</ul>

      
      <span class="pagenumber">7</span>
      </article>
  
  
  
      <article >
      
        <h3>Dot HTTP Format</h3>
        <pre><code class="language-http">POST /register HTTP/1.1
Host: example.com
User-Agent: Go-http-client/1.1
Content-Length: 58
Content-Type: application/json;charset=utf-8
Accept-Encoding: gzip

{
 &quot;email&quot;: &quot;john.doe@mail.com&quot;,
 &quot;password&quot;: &quot;p@$$w0rd&quot;
}

---

HTTP/1.1 201 Created
Connection: close

{
 &quot;data&quot;: {
  &quot;accessToken&quot;: &quot;@cc3$$T0k3n&quot;
 }
}
</code></pre>

      
      <span class="pagenumber">8</span>
      </article>
  
  
  
      <article >
      
        <h3>JSON Format</h3>
        <p>JSON Dump:</p>
<pre><code class="language-json">{
 &quot;name&quot;: &quot;John Appleseed&quot;,
 &quot;age&quot;: 13,
 &quot;isMarried&quot;: true,
 &quot;bornAt&quot;: &quot;2023-06-04T14:11:16.19331+08:00&quot;
}
</code></pre>

      
      <span class="pagenumber">9</span>
      </article>
  
  
  
      <article >
      
        <h3>Diff HTTP</h3>
        <pre><code class="language-diff">=== RUN   TestHTTPDump/post_json
    httpdump.go:63: Request does not match snapshot.
          Snapshot(-)
          Received(+):

          map[string]any{
                &quot;email&quot;:    string(&quot;john.doe@mail.com&quot;),
        +       &quot;name&quot;:     string(&quot;John Doe&quot;),
        -       &quot;password&quot;: string(&quot;p@$$w0rd&quot;),
        +       &quot;password&quot;: string(&quot;p@$$w0rd123&quot;),
          }
</code></pre>

      
      <span class="pagenumber">10</span>
      </article>
  
  
  
      <article >
      
        <h3>Diff JSON</h3>
        <pre><code class="language-diff">=== RUN   TestDumpJSON
    jsondump_test.go:27:
          Snapshot(-)
          Received(+):

          map[string]any{
        -       &quot;age&quot;: float64(13),
        +       &quot;age&quot;: float64(18),
                ... // 1 ignored entry
        +       &quot;hobbies&quot;:   []any{string(&quot;surfing&quot;)},
                &quot;isMarried&quot;: bool(true),
                &quot;name&quot;:      string(&quot;John Appleseed&quot;),
          }
</code></pre>

      
      <span class="pagenumber">11</span>
      </article>
  
  
  
      <article >
      
        <h2>Basic Example</h2>
      
      <span class="pagenumber">12</span>
      </article>
  
  
  
      <article >
      
        <h3>Echo Handler</h3>
        
  <div class="code" >
<pre><span num="13">type EchoRequest struct {</span>
<span num="14">    Message string `json:&#34;message&#34;`</span>
<span num="15">}</span>
</pre>
</div>

  <div class="code" >
<pre><span num="17">func echoHandler(w http.ResponseWriter, r *http.Request) {</span>
<span num="18">    var req EchoRequest</span>
<span num="19">    if err := json.NewDecoder(r.Body).Decode(&amp;req); err != nil {</span>
<span num="20">        http.Error(w, err.Error(), http.StatusBadRequest)</span>
<span num="21">        return</span>
<span num="22">    }</span>
<span num="23"></span>
<span num="24">    if err := json.NewEncoder(w).Encode(req); err != nil {</span>
<span num="25">        http.Error(w, err.Error(), http.StatusInternalServerError)</span>
<span num="26">        return</span>
<span num="27">    }</span>
<span num="28">}</span>
</pre>
</div>

      
      <span class="pagenumber">13</span>
      </article>
  
  
  
      <article >
      
        <h3>Echo Handler - Test</h3>
        
  <div class="code" >
<pre><span num="30">func TestEchoHandler(t *testing.T) {</span>
<span num="31">    b := []byte(`{</span>
<span num="32">        &#34;message&#34;: &#34;hello world&#34;</span>
<span num="33">    }`)</span>
<span num="34">    r := httptest.NewRequest(&#34;POST&#34;, &#34;/echo&#34;, bytes.NewReader(b))</span>
<span num="35"></span>
<span num="36">    testutil.DumpHTTP(t, r, echoHandler)</span>
<span num="37">}</span>
</pre>
</div>

      
      <span class="pagenumber">14</span>
      </article>
  
  
  
      <article >
      
        <h3>Echo Handler - Test Output</h3>
        <p><code>testdata/TestEchoHandler.http</code>:</p>

  <div class="code" >
<pre><span num="1">POST /echo HTTP/1.1</span>
<span num="2">Host: example.com</span>
<span num="3">User-Agent: Go-http-client/1.1</span>
<span num="4">Content-Length: 29</span>
<span num="5">Accept-Encoding: gzip</span>
<span num="6"></span>
<span num="7">{</span>
<span num="8"> &#34;message&#34;: &#34;hello world&#34;</span>
<span num="9">}</span>
<span num="10"></span>
<span num="11">---</span>
<span num="12"></span>
<span num="13">HTTP/1.1 200 OK</span>
<span num="14">Connection: close</span>
<span num="15">Content-Type: text/plain; charset=utf-8</span>
<span num="16"></span>
<span num="17">{</span>
<span num="18"> &#34;message&#34;: &#34;hello world&#34;</span>
<span num="19">}</span>
</pre>
</div>

      
      <span class="pagenumber">15</span>
      </article>
  
  
  
      <article >
      
        <h3>Echo Handler - Code Changes</h3>
        <p>What happens if we change the message from <code>hello world</code> to <code>hello, go</code>?</p>
<pre><code class="language-diff">func TestEchoHandler(t *testing.T) {
    b := []byte(`{
-        &quot;message&quot;: &quot;hello world&quot;
+        &quot;message&quot;: &quot;hello, go&quot;
    }`)
    r := httptest.NewRequest(&quot;POST&quot;, &quot;/echo&quot;, bytes.NewReader(b))
    ...
}
</code></pre>

      
      <span class="pagenumber">16</span>
      </article>
  
  
  
      <article >
      
        <h3>Echo Handler - Diff Output</h3>
        <p>We will see the diff:</p>
<pre><code class="language-bash">=== RUN   TestEchoHandler
    httpdump.go:94: Request does not match snapshot.
          Snapshot(-)
          Received(+):

          map[string]any{
        -       &quot;message&quot;: string(&quot;hello world&quot;),
        +       &quot;message&quot;: string(&quot;hello, go&quot;),
          }

--- FAIL: TestEchoHandler (0.00s)
FAIL
exit status 1
FAIL    github.com/alextanhongpin/go-slides/asset/snippets      0.414s
</code></pre>

      
      <span class="pagenumber">17</span>
      </article>
  
  
  
      <article >
      
        <h3>Advanced</h3>
        <ul>
<li>
<p>how to handle non-deterministic fields</p>
<ul>
<li>id generation</li>
<li>timestamp</li>
<li>random number</li>
</ul>
</li>
<li>
<p>middleware</p>
<ul>
<li>injecting context</li>
<li>decorating handler</li>
</ul>
</li>
<li>
<p>dependencies</p>
</li>
</ul>

      
      <span class="pagenumber">18</span>
      </article>
  
  

      <article>
        <h3>Thank you</h3>
        
          <div class="presenter">
            
  
  <p>
    Alex Tan Hong Pin
  </p>
  

  
  <p>
    Sofware Engineer
  </p>
  
<p class="link"><a href="mailto:alextan220990@gmail.com" target="_blank">alextan220990@gmail.com</a></p><p class="link"><a href="https://alextanhongpin.github.io/" target="_blank">https://alextanhongpin.github.io/</a></p>
          </div>
        
          <div class="presenter">
            
  
  <p>
    
  </p>
  

          </div>
        
      </article>

    </section>

    <div id="help">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
    </div>

    

  </body>
</html>
